<div class="col-md-offset-2 col-md-10 col-lg-offset-2 col-lg-10 albumsPage">
<!--INICIO DE CONTENIDO-->
    <div class="row center-block perfilContenido">
        <div class="headerExplorer col-lg-12" data-url="{{ path('MozcuMozcuBundle_albumsNextPage', {'page' : 0}) }}">
            <div class="btn-group btnTag tag">
                <button type="button" class="btn btn-default dropdown-toggle dropdownButton"
                        data-toggle="dropdown">
                    <span class="name">Todos los tags</span> <span class="caret"></span>
                </button>
                <input type="hidden" class="filterValue" id="tag" value="" />
                <ul class="dropdown-menu" role="menu">
                    <li><input data-url="{{ path('MozcuMozcuBundle_getTagsLive') }}" type="search" placeholder="Busca un tag" class="form-control"></li>
                    {% for tag in tags %}
                        <li><button data-id="{{ tag.getId }}" class="btn btn-link btnFiltros">{{ tag.getName }}</button></li>
                    {% endfor %}
                </ul>
            </div>
            <div class="btn-group btnUbicacion country">
                <button type="button" class="btn btn-default dropdown-toggle dropdownButton"
                        data-toggle="dropdown"> <span class="name">Todos los países</span><span class="caret"></span>
                </button>
                <input type="hidden" class="filterValue" id="country" value="" />
                <ul class="dropdown-menu" role="menu">
                    <li><input data-url="{{ path('MozcuMozcuBundle_getCountries') }}" type="search" placeholder="Busca un pais" class="form-control"></li>
                    <li><button data-id="12" class="btn btn-link btnFiltros">Argentina</button></li>
                    <li><button data-id="45" class="btn btn-link btnFiltros">Chile</button></li>
                    <li><button data-id="228" class="btn btn-link btnFiltros">Uruguay</button></li>
                    <li><button data-id="28" class="btn btn-link btnFiltros">Bolivia</button></li>
                    <li><button data-id="51" class="btn btn-link btnFiltros">Colombia</button></li>
                    <li><button data-id="178" class="btn btn-link btnFiltros">Perú</button></li>
                    <li><button data-id="32" class="btn btn-link btnFiltros">Brasil</button></li>
                </ul>
            </div>
            <div class="btn-group btnFilter order">
                <button type="button" class="btn btn-default dropdown-toggle dropdownButton"
                      data-toggle="dropdown">
                    <span class="name">Ordenar por</span><span class="caret"></span>
                </button>
                <input type="hidden" class="filterValue" id="order" value="" />
                <ul class="dropdown-menu" role="menu">
                    <li><button data-id="a.downloads" class="btn btn-link btnFiltros">Mas descargados</button></li>
                    <li><button data-id="a.visits" class="btn btn-link btnFiltros">Mas escuchados</button></li>
                    <li><button data-id="a.createdAt" class="btn btn-link btnFiltros">Mas recientes</button></li>
                </ul>
            </div> 
        </div>
                
        {% if tag is defined %}
            <div data-tag="{{ tag.getName }}" class="row headerResultados tagResult">
                <h3>Resultados para "#{{ tag.getName }}"</h3>
            </div>
        {% else %}
            <div class="row headerResultados">
                <h3>Los mas visitados!</h3>
            </div>
        {% endif %}
        
        <!--INICIO DE ALBUMES               -->
        
        {% for album in albums %}
            {{ include('MozcuMozcuBundle:Album:_album.html.twig', {album: album}) }}
        {% endfor %}
        <!--FIN DE ALBUMES-->               
        
        <input type="hidden" id="albumsNextPage" value="{{ path('MozcuMozcuBundle_albumsNextPage', {page: 1}) }}" />
        
    </div>

</div><!--FIN DE CONTENIDO-->

<script type="text/javascript">
$(function(){
    window.scrollTo(0,0);
    
    var loading = false;

    $(window).off('scroll');
    $(window).scroll(function() {
        if($('.albumsPage').length == 0 ) {
            return;
        }
        var currentScroll = $(window).scrollTop() + $(window).height();
        var offset = $('.albumsPage').offset();
        var totalScroll = offset.top + $('.albumsPage').outerHeight(true);
        if(currentScroll + 30 > totalScroll && !loading) {
            loading = true;
            loadMore();
        }
    });
    
    var loadMore = function() {
        var url = $('#albumsNextPage').val();
        
        var params = {};
        if($('.tagResult').length > 0) {
            params.tag = $('.tagResult').data('tag');
        }
        params.filters = getFilters();
        
        $.getJSON(url, params, function(data) {
            if(data.success) {
                $('#albumsNextPage').remove();
                $('.album').last().after(data.html);
                loading = false;
            }
        });
    };
    
    // Filtros
    $('.headerExplorer .dropdown-menu').on('click', '.form-control', function(e) { e.stopPropagation(); });
    
    var lastSearchAjax = null;
    $('.headerExplorer .dropdown-menu').on('keyup', 'input[type=search]', function(e){
        var me = $(this);
        if(lastSearchAjax !== null) {
            lastSearchAjax.abort();
        }
        
        if(me.val().length < 0) {
            removeLiveSearchResult();
            return false;
        }
        lastSearchAjax = $.getJSON(me.data('url'), { term: me.val() }, function (data) {
            if(data.length === 0) {
                return;
            }
            me.parent().nextAll().remove();
            $.each(data, function(key, item) {
                me.parents('ul').append('<li><button data-id="' + item.id + '" class="btn btn-link">' + item.label + '</button></li>')
            });
            lastSearchAjax = null;
        });
    });
    
    $('.headerExplorer .dropdown-menu').on('click', 'button', function(e){
        var me = $(this);
        var url = $('.headerExplorer').data('url');
        
        me.parents('.btn-group').find('.filterValue').val(me.data('id'));
        me.parents('.btn-group').find('.dropdownButton .name').html(me.html());
        
        $.getJSON(url, {filters: getFilters()}, function(data) {
            if(data.success) {
                $('#albumsNextPage').remove();
                $('.album').remove();
                $('.headerResultados').remove();
                $('.headerExplorer').after(data.html);
            }
        });
    });
    
    var getFilters = function() {
        var filters = {tag: $('#tag').val(), country: $('#country').val()};
        if($('#order').val().length > 0) {
            filters.orderBy = {sort: $('#order').val(), order: 'DESC'};
        }
        return filters;
    };

});
    
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-31445417-1', 'auto');
  ga('send', 'pageview');

</script>